# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
---
name: Dagger Security Scan
on:
  push:
    # This empty 'branches' list or omitting it entirely
    # triggers on pushes to ALL branches.
    branches:
      - "**"
    # Optional: ignore tags to avoid double-runs on releases
    tags-ignore:
      - "**"
  pull_request:
jobs:
  scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetch-depth 0 is critical if you decide to
          # add history-scanning (git) later.
          fetch-depth: 0

      - name: Run Dagger Scan
        uses: dagger/dagger-for-github@v8.2.0
        with:
          verb: call
          # Replace 'scan-secrets' with your actual function name
          args: scan-secrets --source .
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
      - name: Notify on Failure
        if: failure()
        run: |
          # Use backslashes to break the URL and parameters onto new lines
          curl -X POST "${{ secrets.NOTIF_SERVER }}/message?token=${{ secrets.NOTIF_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "‚ùå CI Secrets scan Failure: ${{ github.repository }}",
              "message": "The Dagger pipeline failed on branch ${{ github.ref_name }}. Check logs.",
              "priority": 8
            }'
 # lint:
  #   name: Lint
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4
  #
  #     - name: Run Dagger Lint
  #       uses: dagger/dagger-for-github@v8.2.0
  #       with:
  #         verb: call
  #         # Replace 'scan-secrets' with your actual function name
  #         args: lint --source .
  #         cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
