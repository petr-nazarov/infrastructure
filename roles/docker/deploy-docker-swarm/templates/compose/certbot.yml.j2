# services:
  certbot:
    image: certbot/dns-cloudflare:latest
    networks:
      - local_net
    dns:
      - "{{ local_dns }}"
    environment:
      CF_API_TOKEN: "{{ cloudflare_api_token }}"
      EMAIL: "{{ personal_email }}"
      DOMAIN: "{{ public_top_domain }}"
    volumes:
      - "{{ remote_config }}/certs/cloudflare.ini:/cloudflare.ini:ro"
      - "{{ remote_data }}/letsencrypt:/etc/letsencrypt"
    entrypoint: >
      /bin/sh -c "trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;"
    deploy:
      replicas: 1
      placement:
        constraints:
          - "node.role == manager"
      labels:
        - "traefik.enable=false"
        - "glance.hide=true"
