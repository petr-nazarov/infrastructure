services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:15
    networks:
      - local_net
    dns:
      - "{{ local_dns }}"
    volumes:
      - "{{ remote_data }}/wgeasy:/etc/wireguard"
      - "/lib/modules:/lib/modules:ro"
    ports:
      # WireGuard UDP Port - must be host mode for performance/visibility
      - target: 51820
        published: 51820
        protocol: udp
        mode: host
    environment:
      PORT: 51821
      HOST: 0.0.0.0
      INSECURE: "false"
      WG_HOST: "wg-home.{{ public_top_domain }}" # Highly recommended for the config files
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    # Swarm support for sysctls depends on your Docker version
    sysctls:
      net.ipv4.ip_forward: 1
      net.ipv4.conf.all.src_valid_mark: 1
      net.ipv6.conf.all.disable_ipv6: 0
      net.ipv6.conf.all.forwarding: 1
      net.ipv6.conf.default.forwarding: 1
    deploy:
      replicas: 1
      placement:
        constraints:
          - "node.role == manager"
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.wg-easy.rule=Host(`wg-home.{{ public_top_domain }}`)"
        - "traefik.http.routers.wg-easy.entrypoints=websecure"
        - "traefik.http.routers.wg-easy.tls=true"
        - "traefik.http.services.wg-easy.loadbalancer.server.port=51821"
        - "traefik.http.routers.wg-easy.middlewares=force-https@file"
